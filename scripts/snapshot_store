#!/bin/bash -e

if [ -z "$webroot" ]; then
	echo "\$webroot not defined"
	exit 2
fi

if [ -z "$mode" ]; then
	mode="all"
fi

SNAPSHOT_DIR="/var/www/mysite/snapshots"
TIMESTAMP=`date +"%Y-%d-%m_%H-%M-%S"`
LOCAL_SSPAK=${SNAPSHOT_DIR}/${TIMESTAMP}.sspak
REMOTE_SSPAK="s3://${bucket}/${bucket_folder}/${TIMESTAMP}.sspak"

rm -rf ${SNAPSHOT_DIR}
mkdir -p ${SNAPSHOT_DIR}

echo "Running sspak save with mode '${mode}'"
/usr/local/bin/sspak save ${webroot} ${LOCAL_SSPAK} --${mode}

echo "Saving snapshot"
/usr/local/bin/aws s3 --only-show-errors cp ${LOCAL_SSPAK} ${REMOTE_SSPAK}

echo "Cleaning up"
rm -rf ${SNAPSHOT_DIR}

echo "sspak_url=${REMOTE_SSPAK}"

